From 396c827e00e6a2224f191e855bf34d4540710aa3 Mon Sep 17 00:00:00 2001
From: Stanley Chu <yschu@nuvoton.com>
Date: Mon, 15 Aug 2022 13:57:01 +0800
Subject: [PATCH] suuport sync mac from eeprom

Signed-off-by: Stanley Chu <yschu@nuvoton.com>
---
 meson.build                |  1 +
 meson_options.txt          |  2 +
 src/ethernet_interface.cpp |  5 ++
 src/network_config.cpp     | 93 ++++++++++++++++++++++++++++++++++++++
 src/network_config.hpp     |  1 +
 5 files changed, 102 insertions(+)

diff --git a/meson.build b/meson.build
index f227b1a..88ce723 100644
--- a/meson.build
+++ b/meson.build
@@ -22,6 +22,7 @@ conf_data.set(
 conf_data.set('NIC_SUPPORTS_ETHTOOL', get_option('nic-ethtool'))
 conf_data.set('SYNC_MAC_FROM_INVENTORY', get_option('sync-mac'))
 conf_data.set('PERSIST_MAC', get_option('persist-mac'))
+conf_data.set('SYNC_MAC_FROM_EEPROM', get_option('sync-mac-eeprom'))
 
 sdbusplus_dep = dependency('sdbusplus')
 sdbusplusplus_prog = find_program('sdbus++', native: true)
diff --git a/meson_options.txt b/meson_options.txt
index 59d20f4..5d38f64 100644
--- a/meson_options.txt
+++ b/meson_options.txt
@@ -14,3 +14,5 @@ option('hyp-nw-config', type : 'boolean',
        description : 'ibm-oem: Enable the hypervisor network manager')
 option('persist-mac', type: 'boolean',
        description: 'Permit the MAC address to be written to the systemd.network config')
+option('sync-mac-eeprom', type: 'boolean',
+       description: 'Sync mac address from fru eeprom')
diff --git a/src/ethernet_interface.cpp b/src/ethernet_interface.cpp
index 1e63a48..ec6a4a4 100644
--- a/src/ethernet_interface.cpp
+++ b/src/ethernet_interface.cpp
@@ -6,6 +6,7 @@
 #include "neighbor.hpp"
 #include "network_manager.hpp"
 #include "vlan_interface.hpp"
+#include "network_config.hpp"
 
 #include <arpa/inet.h>
 #include <fmt/format.h>
@@ -1215,6 +1216,10 @@ std::string EthernetInterface::macAddress(std::string value)
     }
 #endif // HAVE_UBOOT_ENV
 
+#ifdef SYNC_MAC_FROM_EEPROM
+    phosphor::network::bmc::writeMACtoEEPROM(validMAC);
+#endif
+
     return value;
 }
 
diff --git a/src/network_config.cpp b/src/network_config.cpp
index 94c8eae..ad159cf 100644
--- a/src/network_config.cpp
+++ b/src/network_config.cpp
@@ -1,9 +1,19 @@
 #include "config.h"
 
 #include "network_config.hpp"
+#include "ethernet_interface.hpp"
 
 #include <fstream>
 #include <string>
+#include <nlohmann/json.hpp>
+#include <arpa/inet.h>
+#include <net/if.h>
+#include <netinet/in.h>
+#include <phosphor-logging/elog-errors.hpp>
+#include <phosphor-logging/log.hpp>
+
+constexpr auto configFile = "/usr/share/network/config.json";
+using namespace phosphor::logging;
 
 namespace phosphor
 {
@@ -12,6 +22,86 @@ namespace network
 
 namespace bmc
 {
+
+void writeMACtoEEPROM(std::string MACstr)
+{
+    std::ifstream in(configFile);
+    nlohmann::json configJson;
+    in >> configJson;
+
+    ether_addr newMAC = phosphor::network::mac_address::fromString(MACstr);
+    auto eeprom_entry = configJson.find("eeprom");
+    auto offset_entry = configJson.find("mac_offset");
+    if (eeprom_entry != configJson.end() && offset_entry != configJson.end())
+    {
+        auto eeprom_path = (*eeprom_entry).get<std::string>();
+	auto mac_offset = (*offset_entry).get<std::string>();
+        std::ofstream eeprom(eeprom_path);
+        eeprom.seekp(std::stoul(mac_offset, nullptr, 16));
+	if (eeprom.fail())
+	{
+            log<level::ERR>("Invalid offset in EEPROM");
+            eeprom.close();
+            in.close();
+            return;
+	}
+        eeprom.write((char *)&newMAC, 6);
+	if (eeprom.fail())
+	{
+           log<level::ERR>("Fail to write MAC to EEPROM");
+	} else
+	{
+           log<level::INFO>("write MAC to EEPROM",
+                    entry("MAC=%s", MACstr.c_str()));
+	}
+        eeprom.close();
+    }
+    in.close();
+}
+
+std::string getMACfromEEPROM(void)
+{
+    std::string MACaddr = "000000000000";
+
+    std::ifstream in(configFile);
+    nlohmann::json configJson;
+    in >> configJson;
+
+    auto eeprom_entry = configJson.find("eeprom");
+    auto offset_entry = configJson.find("mac_offset");
+    if (eeprom_entry != configJson.end() && offset_entry != configJson.end())
+    {
+        auto eeprom_path = (*eeprom_entry).get<std::string>();
+	auto mac_offset = (*offset_entry).get<std::string>();
+	ether_addr mac;
+        std::ifstream eeprom(eeprom_path);
+        eeprom.seekg(std::stoul(mac_offset, nullptr, 16));
+	if (eeprom.fail())
+	{
+            log<level::ERR>("Invalid offset in EEPROM");
+            eeprom.close();
+            in.close();
+            return MACaddr;
+	}
+        eeprom.read((char *)&mac, 6);
+	if (eeprom.gcount() == 6)
+	{
+           MACaddr = phosphor::network::mac_address::toString(mac);
+	   if (!phosphor::network::mac_address::isUnicast(mac)) {
+               log<level::ERR>("MACAddress in EEPROM is not valid",
+                        entry("MAC=%s", MACaddr.c_str()));
+           }
+	}
+        else {
+            log<level::ERR>("No MACAddress in EEPROM");
+        }
+        eeprom.close();
+    }
+    in.close();
+
+    return MACaddr;
+}
+
 void writeDHCPDefault(const std::string& filename, const std::string& interface)
 {
     std::ofstream filestream;
@@ -26,6 +116,9 @@ void writeDHCPDefault(const std::string& filename, const std::string& interface)
     // file is not present, or after the default file has been
     // manually removed.
     filestream << "[Match]\nName=" << interface <<
+#ifdef SYNC_MAC_FROM_EEPROM
+                "\n[Link]\nMACAddress=" << getMACfromEEPROM() <<
+#endif
                 "\n[Network]\nDHCP=true\n"
 #ifdef LINK_LOCAL_AUTOCONFIGURATION
                 "LinkLocalAddressing=yes\n"
diff --git a/src/network_config.hpp b/src/network_config.hpp
index 7260ca2..2ce6352 100644
--- a/src/network_config.hpp
+++ b/src/network_config.hpp
@@ -9,6 +9,7 @@ namespace bmc
 {
 void writeDHCPDefault(const std::string& filename,
                       const std::string& interface);
+void writeMACtoEEPROM(std::string MACaddr);
 }
 
 } // namespace network
-- 
2.17.1

