From c417a6cdbaa60b2b9fb65d9cb24aac34b8ada6e7 Mon Sep 17 00:00:00 2001
From: Brian Ma <chma0@nuvoton.com>
Date: Wed, 15 Jun 2022 16:07:53 +0800
Subject: [PATCH 1/3] Restore and verify BIOS

---
 image_verify.cpp |  1 +
 item_updater.cpp | 24 +++++++++++++++++++++++-
 meson.build      |  2 ++
 3 files changed, 26 insertions(+), 1 deletion(-)

diff --git a/image_verify.cpp b/image_verify.cpp
index 4d874b4..439d8ea 100644
--- a/image_verify.cpp
+++ b/image_verify.cpp
@@ -108,6 +108,7 @@ bool Signature::verifyFullImage()
     }
 
     std::vector<std::string> fullImages = {
+        fs::path(imageDirPath) / "image-bios.sig",
         fs::path(imageDirPath) / "image-bmc.sig",
         fs::path(imageDirPath) / "image-hostfw.sig",
         fs::path(imageDirPath) / "image-kernel.sig",
diff --git a/item_updater.cpp b/item_updater.cpp
index 9bbd6c8..356da51 100644
--- a/item_updater.cpp
+++ b/item_updater.cpp
@@ -846,6 +846,28 @@ bool ItemUpdater::checkImage(const std::string& filePath,
 }
 
 #ifdef HOST_BIOS_UPGRADE
+std::string restoreBIOSVersion()
+{
+    std::string version = "null";
+    fs::path release = fs::path(PERSIST_DIR) / HOST_RELEASE_FILE;
+    if (fs::exists(release))
+    {
+        try
+        {
+            version = VersionClass::getBMCVersion(release.string());
+        }
+        catch (const std::exception& e)
+        {
+            warning("Failed to parse BIOS version: {ERROR}", "ERROR", e);
+        }
+    }
+    else
+    {
+        info("No bios version file exist");
+    }
+    return version;
+}
+
 void ItemUpdater::createBIOSObject()
 {
     std::string path = BIOS_OBJPATH;
@@ -862,7 +884,7 @@ void ItemUpdater::createBIOSObject()
     createUpdateableAssociation(path);
 
     auto versionId = path.substr(pos + 1);
-    auto version = "null";
+    auto version = restoreBIOSVersion();
     AssociationList assocs = {};
     biosActivation = std::make_unique<Activation>(
         bus, path, *this, versionId, server::Activation::Activations::Active,
diff --git a/meson.build b/meson.build
index 92db933..2ae8c66 100644
--- a/meson.build
+++ b/meson.build
@@ -57,6 +57,8 @@ conf.set_quoted('UPDATEABLE_REV_ASSOCIATION', 'software_version')
 conf.set_quoted('BMC_ROFS_PREFIX', get_option('media-dir') + '/rofs-')
 # The name of the BMC table of contents file
 conf.set_quoted('OS_RELEASE_FILE', '/etc/os-release')
+# The name of the host firmware version file
+conf.set_quoted('HOST_RELEASE_FILE', 'bios-release')
 # The dir where activation data is stored in files
 conf.set_quoted('PERSIST_DIR', '/var/lib/phosphor-bmc-code-mgmt/')
 
-- 
2.34.1

